version: 0.2

env:
  variables:
    JAVA_HOME: "/usr/lib/jvm/java-21-amazon-corretto"
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx2g"
    # ARM64 ìµœì í™” JVM ì˜µì…˜
    _JAVA_OPTIONS: "-XX:+UseG1GC -XX:+UseStringDeduplication -XX:MaxRAMPercentage=75.0"
    # ë¹Œë“œ í™˜ê²½ ì‹ë³„
    BUILD_ARCH: "arm64"
    PROJECT_NAME: "coffee-shout"


phases:
  install:
    runtime-versions:
      java: corretto21
    commands:
      - echo "ğŸ“¦ Installing dependencies for Coffee-Shout ARM64 build..."
      - chmod +x gradlew

      - echo "ğŸ” Environment validation..."
      - echo "Build Architecture: $(uname -m)"
      - echo "Expected:
          aarch64, Got: $(uname -m)"
      - echo "Java Architecture: $(java -XshowSettings:properties -version 2>&1 | grep 'os.arch' | head -1)"
      - echo "Java Version: $(java -version 2>&1 | head -1)"
      - echo "Available Memory: $(free -h | grep Mem)"
      - echo "CPU Info: $(nproc) cores available"
      
      # ì›ì¹™ 4: ARM64 í™˜ê²½ ê°•ì œ ê²€ì¦
      - |
        if [ "$(uname -m)" != "aarch64" ]; then
          echo "âŒ CRITICAL: Build environment is not ARM64!"
          echo "   Expected: aarch64, Got: $(uname -m)"
          echo "   This will cause compatibility issues with ARM64 EC2 runtime!"
          exit 1
        else
          echo "âœ… ARM64 build environment confirmed - matches target EC2"
        fi

  pre_build:
    commands:
      - echo "ğŸš€ Pre-build phase starting..."

      - echo "ğŸ“‹ Build Information:"
      - echo "  Project: $PROJECT_NAME"
      - echo "  Architecture: $BUILD_ARCH"
      - echo "  Java Home: $JAVA_HOME"
      - echo "  Gradle Options: $GRADLE_OPTS"
      - echo "  Build Time: $(date)"
      - echo "  Commit SHA: ${CODEBUILD_RESOLVED_SOURCE_VERSION:-unknown}"
      
      # Gradle í™˜ê²½ ê²€ì¦
      - cd backend
      - echo "ğŸ“ Current directory: $(pwd)"
      - echo "ğŸ“‚ Backend directory contents:"
      - ls -la
      
      # ì›ì¹™ 4: ì—£ì§€ ì¼€ì´ìŠ¤ ëŒ€ë¹„ - Gradle wrapper ê²€ì¦
      - |
        if [ ! -f "gradlew" ]; then
          echo "âŒ Gradle wrapper not found!"
          exit 1
        fi
        if [ ! -x "gradlew" ]; then
          echo "âŒ Gradle wrapper is not executable!"
          exit 1
        fi
        echo "âœ… Gradle wrapper verified"

      - echo "ğŸ”§ Gradle version:"
      - ./gradlew --version

      - echo "ğŸ” Checking for ARM64 incompatible dependencies..."
      - ./gradlew dependencies --configuration compileClasspath | grep -i "native\|jna\|jni\|sqlite" || echo "âœ… No risky native dependencies found"

  build:
    commands:
      - echo "ğŸ—ï¸ Build phase starting for ARM64..."
      - cd backend

      - echo "ğŸ§ª Running comprehensive tests..."
      - echo "  - Unit tests"
      - echo "  - Integration tests"
      - echo "  - ARM64 compatibility tests"
      
      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ARM64 í™˜ê²½ì—ì„œ)
      - ./gradlew clean test --info --stacktrace
      
      # ì›ì¹™ 4: ì—£ì§€ ì¼€ì´ìŠ¤ ëŒ€ë¹„ - í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìƒì„¸ ê²€ì¦
      - |
        TEST_RESULT=$?
        if [ $TEST_RESULT -ne 0 ]; then
          echo "âŒ Tests failed! Build cannot continue."
          echo "ğŸ” Test failure details:"
          find build/reports/tests -name "*.html" -exec echo "Report: {}" \;
          exit 1
        else
          echo "âœ… All tests passed successfully!"
        fi
      
      # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ì›ì¹™ 2: ì„œë²„ ê¶Œìœ„ì„±)
      - echo "ğŸ“Š Running code quality checks..."
      - ./gradlew check --continue || echo "âš ï¸ Code quality issues detected (non-blocking)"
      
      # ARM64 ìµœì í™” ë¹Œë“œ
      - echo "ğŸ¯ Building optimized JAR for ARM64 runtime..."
      - echo "  Using ARM64-optimized JVM settings"
      - echo "  Target: Graviton EC2 instances"

      - ./gradlew build -x test \
        -Dorg.gradle.jvmargs="-Xmx3g -XX:+UseG1GC -XX:+UseStringDeduplication" \
        --parallel \
        --build-cache \
        --configuration-cache
      
      # JAR íŒŒì¼ëª… í‘œì¤€í™” (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í˜¸í™˜ì„±)
      - echo "ğŸ“‹ Standardizing JAR filename..."
      - JAR_FILE=$(find build/libs -name "*.jar" -not -name "*-plain.jar" | head -1)
      - |
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ No executable JAR found!"
          exit 1
        fi
        echo "  Source: $(basename $JAR_FILE)"
        cp "$JAR_FILE" ../coffee-shout-backend.jar
        echo "  Target: coffee-shout-backend.jar"
        echo "âœ… JAR file standardized"

  post_build:
    commands:
      - echo "ğŸ Post-build phase starting..."
      - cd ..

      - echo "ğŸ” Final artifact verification..."
      
      # JAR íŒŒì¼ ì¡´ì¬ í™•ì¸
      - |
        if [ ! -f "coffee-shout-backend.jar" ]; then
          echo "âŒ Final JAR file not found!"
          echo "ğŸ“‚ Current directory contents:"
          ls -la
          exit 1
        fi
        echo "âœ… JAR file exists: coffee-shout-backend.jar"
      
      # JAR íŒŒì¼ ìƒì„¸ ë¶„ì„
      - echo "ğŸ“Š JAR file detailed analysis:"
      - echo "  Size: $(du -h coffee-shout-backend.jar | cut -f1)"
      - echo "  Type: $(file coffee-shout-backend.jar)"
      - echo "  Permissions: $(ls -l coffee-shout-backend.jar | cut -d' ' -f1)"
      
      # ARM64 ëŸ°íƒ€ì„ í˜¸í™˜ì„± ë¹ ë¥¸ ê²€ì¦
      - echo "ğŸ§ª ARM64 runtime compatibility test..."
      - |
        echo "  Testing JAR startup on ARM64..."
        timeout 45s java -jar coffee-shout-backend.jar \
          --spring.profiles.active=test \
          --server.port=0 \
          --spring.main.web-environment=false \
          --spring.jpa.hibernate.ddl-auto=none \
          --spring.datasource.url=jdbc:h2:mem:testdb \
          --logging.level.root=ERROR \
          --spring.main.banner-mode=off \
          > startup-test.log 2>&1 &
        
        PID=$!
        sleep 15
        
        if kill -0 $PID 2>/dev/null; then
          echo "âœ… Application started successfully on ARM64"
          kill $PID 2>/dev/null || true
          wait $PID 2>/dev/null || true
        else
          echo "âŒ Application failed to start on ARM64!"
          echo "ğŸ” Startup log:"
          cat startup-test.log
          exit 1
        fi
        
      # ìµœì¢… ë¹Œë“œ ìš”ì•½
      - echo ""
      - echo "ğŸ‰ ===== BUILD SUMMARY ====="
      - echo "ğŸ“¦ Artifact: coffee-shout-backend.jar ($(du -h coffee-shout-backend.jar | cut -f1))"
      - echo "ğŸ—ï¸  Architecture: ARM64 (aarch64)"
      - echo "â˜• Java Version: $(java -version 2>&1 | head -1 | cut -d'"' -f2)"
      - echo "ğŸŒ± Spring Boot: $(grep -o 'spring-boot-starter.*' backend/build.gradle.kts | head -1 || echo 'detected')"
      - echo "â° Build Time: $(date)"
      - echo "ğŸ†” Build ID: ${CODEBUILD_BUILD_ID:-local}"
      - echo "âœ… Status: READY FOR ARM64 DEPLOYMENT"
      - echo "=========================="

artifacts:
  files:
    - coffee-shout-backend.jar      # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
#    - appspec.yml                   # CodeDeploy ì„¤ì •
  name: coffee-shout-backend-arm64-$(date +%Y%m%d-%H%M%S)
  type: zip
  
  # ì•„í‹°íŒ©íŠ¸ ë©”íƒ€ë°ì´í„°
  override-artifact-name: true

# ë¹Œë“œ ìºì‹œë¡œ ì†ë„ ê°œì„  ë° ì•ˆì •ì„± í™•ë³´
cache:
  paths:
    - '/root/.gradle/caches/**/*'     # Gradle ì˜ì¡´ì„± ìºì‹œ
    - '/root/.gradle/wrapper/**/*'    # Gradle wrapper ìºì‹œ
    - 'backend/.gradle/**/*'          # í”„ë¡œì íŠ¸ë³„ Gradle ìºì‹œ

reports:
  junit:
    files:
      - 'backend/build/test-results/test/*.xml'
    name: 'coffee-shout-test-report'
