name: be-delete-merged-branch.yml

on:
  pull_request:
    branches:
      - be/dev
    types:
      - closed

jobs:
  delete-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get branch name
        id: branch-name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Merged branch: $BRANCH_NAME"

      - name: Delete merged branch
        run: |
          BRANCH_NAME="${{ steps.branch-name.outputs.branch }}"
          
          # ë³´í˜¸ëœ ë¸Œëœì¹˜ë“¤ì€ ì‚­ì œí•˜ì§€ ì•ŠìŒ (main, master, develop, be/dev ë“±)
          PROTECTED_BRANCHES=("main" "master" "develop" "be/dev" "be/main" "staging" "production")
          
          for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$protected" ]]; then
              echo "âš ï¸  Protected branch '$BRANCH_NAME' will not be deleted"
              exit 0
            fi
          done
          
          # ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "ğŸ—‘ï¸  Deleting branch: $BRANCH_NAME"
            git push origin --delete "$BRANCH_NAME"
            echo "âœ… Branch '$BRANCH_NAME' has been deleted successfully"
          else
            echo "â„¹ï¸  Branch '$BRANCH_NAME' does not exist or already deleted"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch-name.outputs.branch }}';
            
            // ë³´í˜¸ëœ ë¸Œëœì¹˜ ì²´í¬
            const protectedBranches = ['main', 'fe/prod', 'fe/dev', 'be/dev', 'be/prod'];
            
            if (protectedBranches.includes(branchName)) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âš ï¸ Protected branch \`${branchName}\` was not deleted automatically.`
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸ—‘ï¸ Branch \`${branchName}\` has been automatically deleted after merge.`
              });
            }

  # ì„ íƒì‚¬í•­: ì‚­ì œëœ ë¸Œëœì¹˜ë“¤ì„ ì¶”ì í•˜ëŠ” ì¡
  log-deleted-branch:
    if: github.event.pull_request.merged == true
    needs: delete-branch
    runs-on: ubuntu-latest

    steps:
      - name: Log deletion
        run: |
          echo "Branch deletion completed for PR #${{ github.event.number }}"
          echo "- PR Title: ${{ github.event.pull_request.title }}"
          echo "- Author: ${{ github.event.pull_request.user.login }}"
          echo "- Merged branch: ${{ github.head_ref }}"
          echo "- Target branch: ${{ github.base_ref }}"
          echo "- Merge time: $(date -u)"
          
