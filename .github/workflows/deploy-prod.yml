name: Deploy to PROD

on:
  push:
    branches:
      - be/prod
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-prod.yml'
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  DEPLOY_PATH: /opt/coffee-shout
  JAR_NAME: coffee-shout-backend.jar

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Java 21 ì„¤ì •
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      # 3. Gradle ê¶Œí•œ ì„¤ì •
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (PRODëŠ” í…ŒìŠ¤íŠ¸ í•„ìˆ˜)
      - name: Run Tests
        run: ./gradlew test

      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            backend/build/test-results/test/*.xml

      # 6. ë¹Œë“œ
      - name: Build
        run: ./gradlew build -x test

      # 7. JAR íŒŒì¼ ì´ë¦„ ë³€ê²½
      - name: Rename JAR file
        run: |
          cd build/libs
          mv *.jar ${{ env.JAR_NAME }}

      # 8. JAR íŒŒì¼ ì—…ë¡œë“œ (artifact)
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: backend/build/libs/${{ env.JAR_NAME }}
          retention-days: 5

  deploy:
    runs-on: ubuntu-latest
    needs: build
    # environment:
    #   name: production
    #   url: https://your-domain.com
    # ìœ„ ì£¼ì„ì„ í•´ì œí•˜ë©´ GitHub Environment Protection Rules ì ìš©
    # (ìˆ˜ë™ ìŠ¹ì¸, ëŒ€ê¸° ì‹œê°„ ë“± ì„¤ì • ê°€ëŠ¥)

    steps:
      # 1. JAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: ./

      # 2. SSH í‚¤ ì„¤ì •
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      # 3. ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
      - name: Create deploy directory
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "mkdir -p ${{ env.DEPLOY_PATH }}/{backup,logs}"

      # 4. ë°°í¬ ì „ í—¬ìŠ¤ì²´í¬
      - name: Pre-deployment health check
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            'if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then \
              echo "âœ… Current application is healthy"; \
            else \
              echo "âš ï¸ Current application is not responding"; \
            fi'

      # 5. ê¸°ì¡´ JAR ë°±ì—…
      - name: Backup existing JAR
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "if [ -f ${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }} ]; then \
              BACKUP_NAME=${{ env.JAR_NAME }}.$(date +%Y%m%d_%H%M%S); \
              cp ${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }} \
              ${{ env.DEPLOY_PATH }}/backup/\$BACKUP_NAME; \
              echo \"Backup created: \$BACKUP_NAME\"; \
              ls -lh ${{ env.DEPLOY_PATH }}/backup/ | tail -5; \
            fi"

      # 6. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ì„ íƒì‚¬í•­)
      - name: Backup database
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && \
            docker compose exec -T mysql mysqldump \
              -u root -p\$MYSQL_ROOT_PASSWORD \
              --all-databases --single-transaction --quick \
              > backup/mysql_backup_$(date +%Y%m%d_%H%M%S).sql || echo 'DB backup skipped'"

      # 7. JAR íŒŒì¼ ì „ì†¡
      - name: Copy JAR to server
        run: |
          scp ${{ env.JAR_NAME }} \
            ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

      # 8. Graceful shutdown (30ì´ˆ ëŒ€ê¸°)
      - name: Graceful shutdown
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "if pgrep -f ${{ env.JAR_NAME }} > /dev/null; then \
              echo 'â³ Graceful shutdown in progress...'; \
              kill -SIGTERM \$(pgrep -f ${{ env.JAR_NAME }}) || true; \
              for i in {1..30}; do \
                if ! pgrep -f ${{ env.JAR_NAME }} > /dev/null; then \
                  echo 'âœ… Application stopped gracefully'; \
                  break; \
                fi; \
                echo \"Waiting for graceful shutdown... (\$i/30)\"; \
                sleep 1; \
              done; \
              if pgrep -f ${{ env.JAR_NAME }} > /dev/null; then \
                echo 'âš ï¸ Force killing application...'; \
                pkill -9 -f ${{ env.JAR_NAME }} || true; \
              fi; \
            fi"

      # 9. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘
      - name: Start application
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && \
            nohup java -jar \
              -Dspring.profiles.active=prod \
              -Xms1024m -Xmx1536m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -verbose:gc \
              -XX:+PrintGCDetails \
              -XX:+PrintGCTimeStamps \
              -Xloggc:logs/gc.log \
              ${{ env.JAR_NAME }} \
              > logs/application.log 2>&1 &"

      # 10. í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 3ë¶„ ëŒ€ê¸°)
      - name: Health check
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            'for i in {1..36}; do \
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then \
                echo "âœ… Application is healthy!"; \
                curl -s http://localhost:8080/actuator/health | jq .; \
                exit 0; \
              fi; \
              echo "â³ Waiting for application to start... ($i/36)"; \
              sleep 5; \
            done; \
            echo "âŒ Health check failed!"; \
            exit 1'

      # 11. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… PROD ë°°í¬ ì„±ê³µ!"
          echo "ë¸Œëžœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"

      # 12. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œìž‘..."
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "LATEST_BACKUP=\$(ls -t ${{ env.DEPLOY_PATH }}/backup/*.jar 2>/dev/null | head -1); \
            if [ -n \"\$LATEST_BACKUP\" ]; then \
              echo \"ðŸ“¦ Rolling back to: \$LATEST_BACKUP\"; \
              pkill -9 -f ${{ env.JAR_NAME }} || true; \
              cp \$LATEST_BACKUP ${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }}; \
              cd ${{ env.DEPLOY_PATH }} && \
              nohup java -jar \
                -Dspring.profiles.active=prod \
                -Xms1024m -Xmx1536m \
                ${{ env.JAR_NAME }} \
                > logs/application.log 2>&1 &; \
              sleep 10; \
              for i in {1..20}; do \
                if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then \
                  echo \"âœ… Rollback successful!\"; \
                  exit 0; \
                fi; \
                echo \"Waiting for rollback... (\$i/20)\"; \
                sleep 3; \
              done; \
              echo \"âŒ Rollback failed!\"; \
              exit 1; \
            else \
              echo \"âš ï¸ No backup found, manual intervention required!\"; \
              exit 1; \
            fi"

      # 13. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ PROD ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¸Œëžœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "ì‹¤íŒ¨ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”!"

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      # ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ)
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Cleanup old backups
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} \
            "find ${{ env.DEPLOY_PATH }}/backup -name '*.jar' -mtime +7 -delete && \
            find ${{ env.DEPLOY_PATH }}/backup -name '*.sql' -mtime +7 -delete && \
            echo 'Old backups cleaned up'"
